<?xml version="1.0"?>
<robot name="allegro_hand" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <xacro:include filename="$(find allegro_hand_description)/urdf/common.xacro"/>
  <xacro:property name="b" value="0.02"/> <!-- 0.8 damping // 0.2 ..--> 
  <xacro:property name="c" value="0.8"/> <!-- friction: not used ... -->

  <!-- Include transmissions -->
  <xacro:include filename="$(find allegro_hand_description)/urdf/allegro_hand_transmission.xacro"/>
  
  <!-- Include Gazebo -->
  <xacro:include filename="$(find allegro_hand_description)/urdf/hand_gazebo.xacro"/>



  <!-- High-leveel hand macro -->
  <xacro:macro name="ahand" params="parent_link prefix xyz rpy left  use_ros_control">
    <xacro:ahand_palm parent_link="${parent_link}" xyz="${xyz}" rpy="${rpy}" left="${left}"/>
    <xacro:ahand_finger_1 prefix="${prefix}"/>
    <xacro:ahand_finger_2 prefix="${prefix}"/>
    <xacro:ahand_finger_3 prefix="${prefix}"/>    
    <xacro:ahand_thumb prefix="${prefix}"/>
    <xacro:allegro_hand_gazebo name="ahand" use_ros_control="${use_ros_control}"/>
    <xacro:ahand_transmission/>
  </xacro:macro>

  <!-- Fingers -->
  <xacro:macro name="ahand_finger_1" params="prefix">
    <xacro:ahand_finger_dof0 prefix="f1" parent_link="ahand_palm_link" xyz="0 ${-0.044981*left} -0.002298" rpy="${0.0873*left} 0 0" axis="0 0 1"/> 
    <xacro:ahand_finger_dof1 prefix="f1"/>
    <xacro:ahand_finger_dof2 prefix="f1"/>
    <xacro:ahand_finger_dof3 prefix="f1"/>
    <xacro:ahand_finger_dof4 prefix="f1"/>
  </xacro:macro>

  <xacro:macro name="ahand_finger_2" params="prefix"> 
    <xacro:ahand_finger_dof0 prefix="f2" parent_link="ahand_palm_link" xyz="0 0 0" rpy="0 0 ${0}" axis="0 0 1"/>
    <xacro:ahand_finger_dof1 prefix="f2"/>
    <xacro:ahand_finger_dof2 prefix="f2"/>
    <xacro:ahand_finger_dof3 prefix="f2"/>
    <xacro:ahand_finger_dof4 prefix="f2"/>
  </xacro:macro>

  <xacro:macro name="ahand_finger_3" params="prefix"> 
    <xacro:ahand_finger_dof0 prefix="f3" parent_link="ahand_palm_link" xyz="0 ${0.044981*left} -0.002298" rpy="${-0.0873*left} 0 -${0}" axis="0 0 1"/>
    <xacro:ahand_finger_dof1 prefix="f3"/>
    <xacro:ahand_finger_dof2 prefix="f3"/>
    <xacro:ahand_finger_dof3 prefix="f3"/>
    <xacro:ahand_finger_dof4 prefix="f3"/>
  </xacro:macro>

  <xacro:macro name="ahand_thumb" params="prefix">
    <xacro:ahand_thumb_dof0 prefix="thumb" parent_link="ahand_palm_link" xyz="-0.0182 ${-0.0168753*left} -0.07308" rpy="${-3.0543*left} 0 ${PI*(left-1)/2}" axis="0 0 1"/>
    <xacro:ahand_thumb_dof1 prefix="thumb"/>
    <xacro:ahand_thumb_dof2 prefix="thumb"/>
    <xacro:ahand_thumb_dof3 prefix="thumb"/>
    <xacro:ahand_thumb_dof4 prefix="thumb"/>
  </xacro:macro>



  <!-- Components PALM  -->
  <xacro:macro name="ahand_palm" params="parent_link xyz rpy left">
    <joint name="ahand_base_joint" type="fixed">
      <parent link="${parent_link}"/>
      <child link="ahand_palm_link"/>
      <origin xyz="${xyz}" rpy="${rpy}"/>
    </joint>

    <link name="ahand_palm_link">
      <inertial>
        <origin xyz="-0.01 0 -0.05"/>
        <!--origin xyz="-0.01 0 -0.05"/-->
        <xacro:cuboid_inertia_def width="0.04" height="0.095" length="0.10" mass="1.1644"/>
        <mass value="1.1644" />
      </inertial>

      <visual>
        <origin xyz="-0.0282 ${-0.057*left} -0.095" rpy="${PI} 0 0"/> <!-- DONE -->
        <material name="all">
          <color rgba="0.1 0.1 0.1 0.5"/>
        </material>

        <geometry>
         <xacro:if value="${left+1}"> <!-- Hack  to test -1 as false -->
          <mesh filename="${models_path}/allegro_palm_left.dae"/>
        </xacro:if>
        <xacro:unless value="${left+1}">
          <mesh filename="${models_path}/allegro_palm_right.dae"/>
        </xacro:unless>
      </geometry>

    </visual>
    <collision>
      <origin xyz="-0.0282 ${-0.057*left} -0.095" rpy="${PI} 0 0"/> <!-- DONE -->
      <geometry>
       <xacro:if value="${left+1}">
        <mesh filename="${models_path}/allegro_palm_left.dae"/>
      </xacro:if>
      <xacro:unless value="${left+1}">
        <mesh filename="${models_path}/allegro_palm_right.dae"/>
      </xacro:unless>
    </geometry>
  </collision>

</link>

<!--I dont understand the need for this, but it is required for the rest to work ... -->
<joint name="ahand_palm_surface_joint" type="fixed">
  <parent link="ahand_palm_link"/>
  <child link="ahand_palm_surface_link"/>
  <origin xyz="0 0 0.08" rpy="0 0 0"/>
  <limit effort="5" lower="0" upper="${PI}" velocity="5.0"/>
  <dynamics damping="${0.1*b}" friction="${0.1*c}"/>
</joint>
<link name="ahand_palm_surface_link">
  <inertial>
    <mass value="0.000001" />
    <inertia
      ixx="0.000001" ixy="0.0"  ixz="0.0"
      iyy="0.000001" iyz="0.0"
      izz="0.000001" />
    </inertial>
  </link>

  <joint name="ahand_grasp_joint" type="fixed">
    <parent link="ahand_palm_link"/>
    <child link="ahand_grasp_link"/>
    <origin xyz="0 0 0.12" rpy="0 0 0"/>
    <limit effort="5" lower="0" upper="${PI}" velocity="5.0"/>
    <dynamics damping="${0.1*b}" friction="${0.1*c}"/>
  </joint>
  <link name="ahand_grasp_link">
    <inertial>
      <mass value="0.000001" />
      <inertia
        ixx="0.000001" ixy="0.0"  ixz="0.0"
        iyy="0.000001" iyz="0.0"
        izz="0.000001" />
      </inertial>
    </link>

  </xacro:macro>


  <!-- Components MAIN FINGERS  -->
<!--DOF 0-->
<xacro:macro name="ahand_finger_dof0" params="prefix parent_link xyz rpy axis">
	<!-- JOINT 0 -->	
	<joint name="${prefix}_dof0_joint" type="revolute">
		<parent link="${parent_link}"/>
      		<child link="${prefix}_dof0_link"/>
      		<origin xyz="${xyz}" rpy="${rpy}"/>      
      		<axis xyz="${axis}"/>
      		<limit lower="${-26.929016*PI/180.0}" upper="${26.929016*PI/180.0}" effort="100" velocity="100"/>
      		<dynamics damping="${0.1*b}" friction="${0.1*c}"/>
    	</joint>

	<!-- LINK 0 -->    	
	<link name="${prefix}_dof0_link">
		<inertial>
       			<origin xyz="0.00 0 0.01"/>
        			<xacro:cuboid_inertia_def width="0.025" height="0.02" length="0.025" mass="0.011"/>
        		<mass value="0.011" />
      		</inertial>

		<visual>
        		<origin xyz="-0.0098 -0.012 0.0" rpy="${PI/2} ${0} ${0} "/> <!-- DONE, OK -->        
        		<material name="all">
        			<color rgba="0.1 0.1 0.1 0.5"/>
        		</material>
        		<geometry>
        		<mesh filename="${models_path}/allegro_fingerdof0.dae"/>
        		</geometry>
		</visual>

		<collision>
			<origin xyz="-0.0098 -0.012 0.0" rpy="${PI/2} ${0} ${0} "/> <!-- DONE, OK -->        
			<material name="all">
	        		<color rgba="0.1 0.1 0.1 0.5"/>
        		</material>
        		<geometry>
         			<mesh filename="${models_path}/allegro_fingerdof0.dae"/>
        		</geometry>
      		</collision>
	</link>
</xacro:macro>


<!--DOF 1-->
<xacro:macro name="ahand_finger_dof1" params="prefix">
	<!-- JOINT 1 -->
	<joint name="${prefix}_dof1_joint" type="revolute">
      		<parent link="${prefix}_dof0_link"/>
      		<child link="${prefix}_dof1_link"/>
      
		<origin xyz="0 0 0.0164" rpy="${-PI/2} 0 0"/>
      		<axis xyz="0 0 1"/>
      		<limit lower="${-11.229973*PI/180.0}" upper="${92.246205*PI/180.0}" effort="100" velocity="100"/>
      		<dynamics damping="${0.1*b}" friction="${0.1*c}"/>
    	</joint>

	<!-- LINK 1 -->
    	<link name="${prefix}_dof1_link">
      		<inertial>
        		<origin xyz="0.  -0.027 0 "/>
        		<xacro:cuboid_inertia_def width="0.025" height="0.054" length="0.025" mass="0.0682"/>
        		<mass value="0.0682" />
      		</inertial>

      		<visual>
        		<material name="WAMGrey">
          			<color rgba="0.9 0.9 0.9 1.0"/>
        		</material>

        		<origin xyz="-0.0098 -0.0638 0.012" rpy="0 0 ${0}" /> <!-- DONE -->
        		<geometry>
          			<mesh filename="${models_path}/allegro_fingerdof1.dae"/>
        		</geometry>
      		</visual>

      		<collision>
        		<origin xyz=" 0.  -0.027 0  " rpy="${PI/2} 0 ${0}"/>
        		<geometry>
          			<cylinder radius="0.0125" length="0.035"/>
        		</geometry>
      		</collision>
    	</link>
</xacro:macro>

 
<!--DOF 2-->
<xacro:macro name="ahand_finger_dof2" params="prefix">
	<!-- JOINT 2 -->	
	<joint name="${prefix}_dof2_joint" type="revolute">
		<parent link="${prefix}_dof1_link"/>
      		<child link="${prefix}_dof2_link"/>
      		<origin xyz="0.0 -0.054 0.0" rpy="0 0 ${-PI/2}"/> <!-- DONE -->
      		<axis xyz="0 0 1"/>
      		<limit lower="${-9.969466*PI/180.0}" upper="${97.918487*PI/180.0}" effort="100" velocity="100"/>
      		<dynamics damping="${0.1*b}" friction="${0.1*c}"/>
    	</joint>

	<!-- LINK 2 -->    
	<link name="${prefix}_dof2_link">
	
		<inertial>
        		<origin xyz=" 0.0192 0 0 "/>
        		<xacro:cuboid_inertia_def width="0.0384" height="0.025" length="0.025" mass="0.0402"/>
        		<mass value="0.0402" />
      		</inertial>
      		
		<visual>
        		<origin xyz="-0.0098 -0.0098 -0.012" rpy="${PI} 0 ${PI/2}" /> <!-- DONE -->
        		<material name="WAMGrey">
          			<color rgba="0.9 0.9 0.9 0.0"/>
        		</material>
        		<geometry>
          			<mesh filename="${models_path}/allegro_fingerdof2.dae"/>
        		</geometry>
      		</visual>

      		<collision>
        		<origin xyz=" 0.0192 0 0 " rpy="${PI/2} 0 ${PI/2}"/>
        		<geometry>
          			<cylinder radius="0.0125" length="0.05"/>
        		</geometry>
      		</collision>
    	</link>
</xacro:macro>



<!--DOF 3-->
<xacro:macro name="ahand_finger_dof3" params="prefix">
	
	<!-- JOINT 3 -->	
	<joint name="${prefix}_dof3_joint" type="revolute">
		<parent link="${prefix}_dof2_link"/>
		<child link="${prefix}_dof3_link"/>
      		<origin xyz="0.0384 0 0" rpy="0 0 0"/>
      		<axis xyz="0 0 1"/>
      		<limit lower="${-13.006142*PI/180.0}" upper="${92.704571*PI/180.0}" effort="100" velocity="100"/>      
      		<dynamics damping="${0.1*b}" friction="${0.1*c}"/>
    	</joint>
    
	<!-- LINK 3 -->
	<link name="${prefix}_dof3_link">      		
		<inertial>
        		<origin xyz=" 0.01 0 0 "/>
       			<xacro:cuboid_inertia_def width="0.02" height="0.025" length="0.025" mass="0.0094"/>
        		<mass value="0.0094" />
      		</inertial>

      		<visual>
        		<origin xyz="0.016 -0.0098 0.012" rpy="0 0 ${PI/2}"/> 	<!-- DONE -->
        		<material name="WAMGrey">
          			<color rgba="0.9 0.9 0.9 1.0"/>
        		</material>
        		<geometry>
          			<mesh filename="${models_path}/allegro_fingerdof0.dae"/>
        		</geometry>
      		</visual>
      
		<collision>
        		<origin xyz="0.016 -0.0098 0.012" rpy="0 0 ${PI/2}"/> 	<!-- DONE -->
        		<geometry>
          			<mesh filename="${models_path}/allegro_fingerdof0.dae"/>
       			</geometry>
      		</collision>
    	</link>
</xacro:macro>

<!--DOF 4-->
<xacro:macro name="ahand_finger_dof4" params="prefix">
	
	<!-- JOINT 4 -->
	<joint name="${prefix}_dof4_joint" type="fixed">
      		<parent link="${prefix}_dof3_link"/>
      		<child link="${prefix}_dof4_link"/>
      		<origin xyz="0.016 0 0" rpy="0 0 0"/>
    	</joint>
    
	<!-- LINK 4 -->
	<link name="${prefix}_dof4_link">
		<inertial>
        		<origin xyz=" 0.01 0 0 "/>
        		<xacro:cuboid_inertia_def width="0.02" height="0.020" length="0.020" mass="0.0176"/>
        		<mass value="0.0176" />
      		</inertial>

      		<visual>
       			<origin xyz="0 0.012 0.012" rpy="0 0 ${-PI/2}"/> 	<!-- DONE -->
        		<material name="WAMGrey">
          			<color rgba="0.9 0.9 0.9 0.0"/>
        		</material>
        		<geometry>
          			<mesh filename="${models_path}/allegro_fingertip.dae"/>
        		</geometry>
      		</visual>

      		<collision name="${prefix}_dof4_link_collision">
        		<origin xyz=" 0.01 0 0 " rpy="0 0 ${-PI/2}"/>
        		<geometry>
          			<sphere radius="0.01" />
        		</geometry>
      		</collision>
	</link>
</xacro:macro>




<!-- Components THUMB  -->
<!--DOF 0 THUMB-->
<xacro:macro name="ahand_thumb_dof0" params="prefix parent_link xyz rpy axis">

	<!-- JOINT 0 THUMB -->	
	<joint name="${prefix}_dof0_joint" type="revolute">
		<parent link="${parent_link}"/>
      		<child link="${prefix}_dof0_link"/>
      		<origin xyz="${xyz}" rpy="${rpy}"/>      
      		<axis xyz="${axis}"/> 
     		<limit lower="-1.0" upper="85.0" effort="100" velocity="100"/> <!-- new version, it still needs to be negative ... -->       
      		<dynamics damping="${0.1*b}" friction="${0.1*c}"/>
    	</joint>

	<link name="${prefix}_dof0_link">
		<inertial>
        		<origin xyz="-0.0025 0.02 -0.01 "/>
                	<xacro:cuboid_inertia_def width="0.02" height="0.04" length="0.04" mass="0.0001"/>
        		<mass value="0.0001" />
      		</inertial>
      		
		<visual>
        		<origin xyz="0.025 -0.0088 0.010" rpy="${-PI/2} ${0} ${PI} "/> <!-- DONE -->        
        		<material name="all">
          			<color rgba="0.1 0.1 0.1 0.5"/>
        		</material>
        		<geometry>
          			<mesh filename="${models_path}/allegro_thumbdof0.dae"/>
        		</geometry>
      		</visual>
      		<!--collision>
        		<origin xyz="0.025 -0.0088 0.010" rpy="${-PI/2} ${0} ${PI} "/> 
        		<geometry>
          			<mesh filename="${models_path}/shapes/allegro_thumbdof0.dae"/>
        		</geometry>
      		</collision-->
	</link>
</xacro:macro>



<!--DOF 1 THUMB-->
<xacro:macro name="ahand_thumb_dof1" params="prefix">
	
	<!-- JOINT 1 THUMB -->
	<joint name="${prefix}_dof1_joint" type="revolute">
		<parent link="${prefix}_dof0_link"/>
 		<child link="${prefix}_dof1_link"/>
      		<origin xyz="0 0.0375 -0.0034" rpy="${-PI/2} ${0} ${0}"/> <!-- DONE -->
      		<axis xyz="0 0 1"/>
      		<limit lower="-66.0" upper="6.0" effort="100" velocity="100"/>
      		<dynamics damping="${0.1*b}" friction="${0.1*c}"/>
    	</joint>
    
	<!-- LINK 1 THUMB -->
	<link name="${prefix}_dof1_link">
      		<inertial>
        		<origin xyz="0.00 0.00 0.015 "/>
                	<xacro:cuboid_inertia_def width="0.02" height="0.02" length="0.02" mass="0.0001"/>
        		<mass value="0.0001" />
      		</inertial>

      		<visual>
       			<material name="WAMGrey">
          			<color rgba="0.9 0.9 0.9 0.0"/>
        		</material>
        		<origin xyz="0.012 -0.0098 0" rpy="${PI/2} ${0} ${PI/2}" /> <!-- DONE -->
        		<geometry>
          			<mesh filename="${models_path}/allegro_fingerdof0.dae"/>
        		</geometry>
      		</visual>
	  	 	
		<!--collision>
	       		<origin xyz="0.012 -0.0098 0" rpy="${PI/2} ${0} ${PI/2}" />
        		<geometry>
        			<mesh filename="${models_path}/shapes/allegro_fingerdof0.dae"/>
        		</geometry>
      		</collision> -->
	</link>
</xacro:macro>

<!--DOF 2 THUMB-->
<xacro:macro name="ahand_thumb_dof2" params="prefix">
	
	<!-- JOINT 2 THUMB -->
	<joint name="${prefix}_dof2_joint" type="revolute">
      		<parent link="${prefix}_dof1_link"/>
      		<child link="${prefix}_dof2_link"/>
      		<origin xyz="0 0 0.0177" rpy="${-PI/2} 0 ${PI/2}"/> <!-- DONE -->
      		<axis xyz="0 0 1"/>
      		<limit lower="-10.8" upper="94.0" effort="100" velocity="100"/>      
      		<dynamics damping="${0.1*b}" friction="${0.1*c}"/>
    	</joint>
     	
	<!-- LINK 2 THUMB -->
	<link name="${prefix}_dof2_link">
		<inertial>
        		<origin xyz="0.00 -0.028 0.00 "/>
                	<xacro:cuboid_inertia_def width="0.02" height="0.05" length="0.02" mass="0.0001"/>
        		<mass value="0.0001" />
      		</inertial>

      		<visual>
        		<origin xyz="-0.0098 -0.063 0.012" />
        		<material name="WAMGrey">
          			<color rgba="0.9 0.9 0.9 0.0"/>
        		</material>
        	
			<geometry>
          			<mesh filename="${models_path}/allegro_fingerdof1.dae"/>
        		</geometry>
      		</visual>

		<!--<collision>
			<origin xyz="-0.0098 -0.063 0.012" />
        		<geometry>
          			<mesh filename="${models_path}/shapes/allegro_fingerdof1.dae"/>
        		</geometry>
      		</collision> -->
	</link>
</xacro:macro>


<!--DOF 3 THUMB-->
<xacro:macro name="ahand_thumb_dof3" params="prefix">
	
	<!-- JOINT 3 THUMB -->
	<joint name="${prefix}_dof3_joint" type="revolute">
		<parent link="${prefix}_dof2_link"/>
		<child link="${prefix}_dof3_link"/>
		<origin xyz="0 -0.0514 0" rpy="0 0 ${-PI/2}"/> <!-- DONE -->
		<axis xyz="0 0 1"/>
		<limit lower="0.0" upper="98.0" effort="100" velocity="100"/>
	      	<dynamics damping="${0.1*b}" friction="${0.1*c}"/>
	  </joint>

	<!-- LINK 3 THUMB -->
	<link name="${prefix}_dof3_link">
		<inertial>
			<origin xyz="0.025 0.0 0.0 "/>
         		<xacro:cuboid_inertia_def width="0.04" height="0.02" length="0.02" mass="0.0001"/>
      			<mass value="0.0001" />
    		</inertial>

	    	<visual>
	      		<origin xyz="-0.0078 0.0098 0.012" rpy="0 0 ${-PI/2}"/> 	<!-- DONE -->
	      		<material name="WAMGrey">
        		<color rgba="0.9 0.9 0.9 0.0"/>
	      		</material>
	      		<geometry>
	       			<mesh filename="${models_path}/allegro_thumbdof3.dae"/>
	      		</geometry>
	    	</visual>
	</link>


</xacro:macro>

<!--DOF 4 THUMB-->
<xacro:macro name="ahand_thumb_dof4" params="prefix">

	<!-- JOINT 3 THUMB -->
	<joint name="${prefix}_dof4_joint" type="fixed">
   		<parent link="${prefix}_dof3_link"/>
    		<child link="${prefix}_dof4_link"/>
    		<origin xyz="0.046 0 0" rpy="0 0 0"/> <!-- DONE -->
  	</joint>
  
	<!-- LINK 4 THUMB -->
	<link name="${prefix}_dof4_link">
   		<inertial>
    			<origin xyz="0.01 0.0 0.0 "/>
        		<xacro:cuboid_inertia_def width="0.02" height="0.02" length="0.02" mass="0.0001"/>
    			<mass value="0.0001" />
  		</inertial>
 
 		<visual>
    			<origin xyz="0 0.012 0.012" rpy="0 0 ${-PI/2}"/> 	<!-- DONE -->
    			<material name="WAMGrey">
      				<color rgba="0.9 0.9 0.9 0.0"/>
    			</material>
    			<geometry>
      				<mesh filename="${models_path}/allegro_fingertip.dae"/>
    			</geometry>
  		</visual>
 		<!--collision>
   			<origin xyz="0 0.012 0.012" rpy="0 0 ${-PI/2}"/> 
    			<geometry>
      			<mesh filename="${models_path}/shapes/allegro_fingertip.dae"/>
   			</geometry>
  		</collision> -->
	</link>
</xacro:macro>







</robot>
